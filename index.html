<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stranger Things arpeggio JS synth demo</title>
</head>
<body>
    <h1>js-stranger-synth</h1>
    <h4>Recreating iconic Stranger Things arpeggio melody with JavaScript</h4>
    <div>
        <input id="filterFreq" type="range" min="0" max="1" step="0.005" value="0.5" />
        <small>Filter frequency</small>
    </div>
    <div>
        <input id="filterQ" type="range" min="0" max="1" step="0.005" value="0.5" />
        <small>Filter resonance</small>
    </div>
    <br />
    <button id="play">Play</button>
    <button id="stop">Stop</button>
</body>
<script type="text/javascript">
    const notes = [65.41, 82.41, 98.00, 123.47, 130.81];
    const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
    let playing;

    const playBtn = document.querySelector('#play');
    const stopBtn = document.querySelector('#stop');
    const filterFreqEl = document.querySelector('#filterFreq');
    const filterFreqQ = document.querySelector('#filterQ');

    playBtn.addEventListener('click', async () => {
        if (playing) return;

        const actx = new (AudioContext || webkitAudioContext)();
        if (!actx) throw 'Not supported';

        let i = 0;
        let increasing = true;
        playing = true;
        
        // Filter
        const maxFilterFreq = actx.sampleRate / 2;
        const filter = actx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.connect(actx.destination);

        filterFreqEl.addEventListener('input', e => {
            const val = e.target.value;
            filter.frequency.value = val * maxFilterFreq;
        });
        filterFreqQ.addEventListener('input', e => {
            const val = e.target.value;
            filter.Q.value = val * 30;
        });

        // Stop button
        stopBtn.addEventListener('click', () => {
            playing = false;
        });
        
        // Playing notes
        while (playing) {
            const osc = actx.createOscillator();
            osc.type = 'sawtooth';
            osc.connect(filter);
            osc.connect(actx.destination);
            osc.frequency.value = notes[i];
            osc.start();
            await delay(160)
            osc.stop();

            if (increasing) {
                i++;
                if (i === 4) increasing = false;
            } else {
                i--;
                if (i === 0) increasing = true;
            }
        }
    });
</script>
</html>