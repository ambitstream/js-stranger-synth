<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stranger Things arpeggio JS synth demo</title>
</head>
<body>
    <h1>js-stranger-synth</h1>
    <h4>Recreating iconic Stranger Things arpeggio melody with JavaScript</h4>
    <div>
        <input id="filterFreq" type="range" min="50" max="5500" value="440" />
        <small>Filter frequency</small>
    </div>
    <div>
        <input id="filterQ" type="range" min="0" max="30" value="3" />
        <small>Filter resonance</small>
    </div>
    <br />
    <button id="play">Play</button>
    <button id="stop">Stop</button>
</body>
<script type="text/javascript">
    const notesVoice1 = [65.41, 82.41, 98, 123.47, 130.81];
    const notesVoice2 = [130.81, 164.81, 196, 246.94, 261.63];
  
    const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
    let playing;

    const playBtn = document.querySelector('#play');
    const stopBtn = document.querySelector('#stop');
    const filterFreqEl = document.querySelector('#filterFreq');
    const filterFreqQ = document.querySelector('#filterQ');

    playBtn.addEventListener('click', async () => {
        if (playing) return;

        const actx = new (AudioContext || webkitAudioContext)();
        if (!actx) throw 'Not supported';

        let i = 0;
        let increasing = true;
        playing = true;
        
        // Filter
        const filter = actx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 440;
        filter.Q.value = 3;
        filter.connect(actx.destination);

        filterFreqEl.addEventListener('input', e => {
            const val = e.target.value;
            filter.frequency.value = val;
        });
        filterFreqQ.addEventListener('input', e => {
            const val = e.target.value;
            filter.Q.value = val;
        });

        // Stop button
        stopBtn.addEventListener('click', () => {
            playing = false;
        });
        
        // Playing notes
        while (playing) {
            // Voice 1
            const osc1 = actx.createOscillator();
            osc1.type = 'sawtooth';
            osc1.connect(filter);
            osc1.frequency.value = notesVoice1[i];
            osc1.start();
            
            // Voice 2
            const osc2 = actx.createOscillator();
            osc2.type = 'sawtooth';
            osc2.connect(filter);
            osc2.frequency.value = notesVoice2[i];
            osc2.start();

            await delay(160)

            osc1.stop();
            osc2.stop();

            if (increasing) {
                i++;
                if (i === 4) increasing = false;
            } else {
                i--;
                if (i === 0) increasing = true;
            }
        }
    });
</script>
</html>